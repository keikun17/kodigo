# Action Cable


## To broadcast

`ActionCable.server.broadcast(channel, args)`

Ex.
```ruby
class UserGamesChannel < ApplicationCable::Channel
  def subscribed
    stream_from "user_games-#{current_user.id}"
  end

  def add_game(data)
    game = Game.find_by(name: data['game'])
    current_user.games << game
    ActionCable.server.broadcast "user_games-#{current_user.id}",
      games: current_user.games.map(&:name),
      type: 'GAME_ADDED'
  end
```

---

## Minimum setup required to get action cable working on Rails

### Action Cable has three required configurations:
 - A subscription adapter [Step 1]
 - Allowed request origins [Step 2]
 - And the cable server URL (which can optionally be set on the client side) [Step 3]

### Step 1 (Configuration). Edit `config/cable.yml` (file generated by new Rails 5 app generator)

This is the configuration file for your actioncable data.

You might want to edit it to make it look like this :


```
# in app/config/redis/cable.yml

development: &development
  :url: redis://localhost:6379
  :host: localhost
  :port: 6379
  :timeout: 1
  :inline: true
test: *development
```

### Step 2 (Configuration). Configure the allowed request origins


```
# in config/environments/development.rb or config/environments/production.rb
# on development, this defaults to http://localhost:3000

Rails.application.config.action_cable.allowed_request_origins = ['http://url.com', /http:\/\/url.*/]
```

### Step (Configuration) 3. Add the cable route
```
# in config/routes.rb

# Serve websocket cable requests in-process
mount ActionCable.server => '/cable'
```

### Step 4. Add `//=require cable` to the javascript manifest

this will load `app/javascripts/cable.coffee` or `app/javascripts/cable.js` to your application.
All js files that are has cable js functions and actions should be loaded from here.
This file is the manifest for action cable js files

```
# app/assets/javascripts/application.js
//= require jquery
//= require jquery_ujs
//= require turbolinks
//= require cable
```

### Step 5. Edit `app/channels/application_cable/connection`

This file **ONLY** deals with authorization and authentication of cable connections. No other app logic aside from fetching
the identifier (most of the time the 'user') with the token it receive

A configuration that uses the user as the identifier looks like this

```
module ApplicationCable
  class Connection < ActionCable::Connection::Base
    identified_by :current_user

    def connect
      self.current_user = find_verified_user
      logger.add_tags current_user.name
    end

    def disconnect
      # Any cleanup work needed when the cable connection is cut.
    end

    protected
      def find_verified_user
        if current_user = User.find_by_identity cookies.signed[:identity_id]
          current_user
        else
          reject_unauthorized_connection
        end
      end
  end
end

```

More info about this class on : http://www.rubydoc.info/github/rails/actioncable/ActionCable/Connection/Base
